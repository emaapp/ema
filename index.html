<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EMA — Elephant Monitoring App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" href="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png" />
  <meta name="theme-color" content="#ffffff"/>

  <!-- Minimal, clean, mobile-first UI -->
  <style>
    :root {
      --bg: #ffffff;
      --fg: #0f172a;        /* slate-900 */
      --muted: #64748b;     /* slate-500 */
      --accent: #0ea5e9;    /* sky-500 */
      --accent-600:#0284c7; /* sky-600 */
      --ring: rgba(14,165,233,.35);
      --card: #f8fafc;      /* slate-50 */
      --border: #e2e8f0;    /* slate-200 */
      --ok: #16a34a;        /* green-600 */
      --warn: #eab308;      /* amber-500 */
      --err: #ef4444;       /* red-500 */
    }
    html, body { height: 100%; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--fg);
      background: var(--bg);
    }
    .center {
      min-height: 100dvh;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .card {
      width: min(700px, 92vw);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: 0 12px 30px rgba(2,8,23,.06);
      padding: 20px;
    }
    h1, h2, h3 { margin: 0 0 6px; }
    h1 { font-size: 1.35rem; letter-spacing: .2px; }
    p { margin: 6px 0; color: var(--muted); }

    .stack { display: grid; gap: 14px; }
    .row   { display: flex; gap: 10px; align-items: center; }
    .between { display:flex; align-items:center; gap:12px; color: var(--muted); font-size: .92rem; }
    .between::before, .between::after {
      content:"";
      height:1px; flex:1; background: var(--border);
    }
    label { font-size: .9rem; color: var(--muted); display:block; margin-bottom:6px; }
    input, select, button, .btn {
      font: inherit;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 12px 14px;
      outline: none;
      width: 100%;
    }
    input:focus, select:focus, button:focus {
      box-shadow: 0 0 0 4px var(--ring);
      border-color: var(--accent);
    }
    input::placeholder { color: #94a3b8; }
    button, .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: transform .05s ease, background .2s ease;
    }
    button:hover { background: var(--accent-600); }
    button:active { transform: translateY(1px); }
    .btn-secondary {
      background: #fff; color: var(--fg); border: 1px solid var(--border);
    }
    .btn-ghost {
      background: transparent; border: 1px dashed var(--border); color: var(--muted);
    }
    .inline-note { font-size:.85rem; color:#94a3b8; }
    .muted { color: #94a3b8; }
    .fade {
      opacity: 0;
      transform: translateY(6px);
      animation: fadein .45s .1s ease forwards;
    }
    @keyframes fadein { to { opacity: 1; transform: translateY(0); } }

    /* Splash */
    #splash {
      position: fixed; inset: 0; display: grid; place-items: center;
      background: #fff; z-index: 50; transition: opacity .5s ease;
    }
    #splash.hidden { opacity: 0; pointer-events: none; }

    .logo {
      width: 84px; height: 84px; border-radius: 18px; object-fit: cover; display:block; margin: 0 auto 10px;
      box-shadow: 0 10px 24px rgba(2,8,23,.08);
    }
    .title { font-weight: 700; font-size: 1.6rem; text-align:center; }
    .subtitle { text-align:center; color: var(--muted); }

    /* Grid for login buttons */
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 480px){ .grid2 { grid-template-columns: 1fr; } }

    /* Checkbox */
    .checkbox { display:flex; gap:10px; align-items:center; color: var(--muted); }
    .checkbox input { width:auto; }

    /* Modal / Sheet */
    .modal {
      position: fixed; inset: 0; display:none; place-items: center; background: rgba(2,8,23,.35);
      z-index: 60; padding: 16px;
    }
    .modal.open { display:grid; }
    .modal .panel {
      background:#fff;border-radius:20px; width:min(820px,94vw); max-height:92vh; overflow:auto; padding:18px;
      box-shadow: 0 14px 40px rgba(2,8,23,.2);
    }
    .modal .panel h2 { font-size:1.1rem; }
    .modal .close-x {
      position:absolute; right:14px; top:10px; background:transparent; border:none; font-size:22px; cursor:pointer; color:#334155;
    }

    /* ID Card preview canvas holder */
    .idcard-wrap { display:grid; gap:10px; justify-items:center; }
    canvas#idcard { width: 100%; max-width: 520px; border-radius: 16px; border:1px solid var(--border); }

    /* Camera scan area */
    .camera-wrap { position: relative; border-radius: 16px; overflow: hidden; }
    video#camera { width: min(560px, 92vw); border-radius: 16px; background: #000; }
    .scan-box {
      position: absolute; inset: 12% 10%;
      border: 3px solid rgba(14,165,233,.8);
      border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0,0,0,.2) inset;
      pointer-events: none;
    }

    .error { color: var(--err); font-size: .92rem; }
    .good  { color: var(--ok);  font-size: .92rem; }

    /* Divider "or" */
    .or { margin: 4px 0; }

    /* Subpage (Register) slide-in */
    .subpage {
      position: relative;
      display: none;
      animation: slideIn .25s ease forwards;
    }
    @keyframes slideIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform:none; } }

    .sr { position:absolute; width:1px; height:1px; overflow:hidden; clip: rect(0 0 0 0); white-space:nowrap;}
  </style>

  <!-- ZXing (QR + Data Matrix scanning) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <!-- QR generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <!-- DataMatrix generator via BWIP-JS -->
  <script src="https://cdn.jsdelivr.net/npm/bwip-js@3.4.4/dist/bwip-js-min.js"></script>

  <!-- PWA: create a manifest on the fly and register a simple Service Worker -->
  <script>
    (function makeManifest(){
      const manifest = {
        name: "EMA — Elephant Monitoring App",
        short_name: "EMA",
        start_url: "./index.html",
        display: "standalone",
        background_color: "#ffffff",
        theme_color: "#ffffff",
        icons: [
          {"src":"https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png","sizes":"512x512","type":"image/png"}
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement("link");
      link.rel = "manifest"; link.href = url;
      document.head.appendChild(link);
    })();

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        const swCode = `
          const CACHE = "ema-pwa-v1";
          const ASSETS = ["./","./index.html"];
          self.addEventListener("install", (e)=> {
            e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()));
          });
          self.addEventListener("activate", (e)=> e.waitUntil(self.clients.claim()));
          self.addEventListener("fetch", (e)=> {
            e.respondWith(
              caches.match(e.request).then(res => res || fetch(e.request).then(r=>{
                const copy = r.clone();
                caches.open(CACHE).then(c=>c.put(e.request, copy)).catch(()=>{});
                return r;
              }).catch(()=>res))
            );
          });
        `;
        const blob = new Blob([swCode], {type:"text/javascript"});
        const swURL = URL.createObjectURL(blob);
        try { await navigator.serviceWorker.register(swURL); } catch {}
      });
    }
  </script>
</head>
<body>

  <!-- Splash (2 seconds) -->
  <div id="splash" role="dialog" aria-label="Splash">
    <div class="card" style="text-align:center; padding:28px 22px;">
      <img class="logo" alt="EMA logo"
           src="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png" />
      <div class="title">EMA — Elephant Monitoring App</div>
      <p class="subtitle">Loading…</p>
      <p class="inline-note">Sponsored message</p>
      <p class="muted" style="font-size:.9rem">Protecting elephants with smarter data.</p>
    </div>
  </div>

  <!-- Login -->
  <main class="center" id="main" aria-live="polite" style="display:none;">
    <section class="card stack fade" id="loginCard">
      <div style="text-align:center">
        <img class="logo"
             src="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png" alt="">
        <h1>Welcome to EMA</h1>
        <p>Secure login for field teams and partners.</p>
      </div>

      <!-- EMA ID -->
      <div>
        <label for="emaId"><strong>EMA ID</strong></label>
        <input id="emaId" name="emaId" inputmode="latin-prose" autocomplete="one-time-code"
               placeholder="XXXXXX-E" maxlength="8" />
      </div>

      <button id="btnLogin">Login</button>

      <div class="between or">or</div>

      <div class="grid2">
        <button id="btnScan" class="btn-secondary">Scan the E-Card</button>
        <button id="btnForgot" class="btn-secondary">Forgot ID</button>
      </div>
      <div style="text-align:center">
        <button id="btnRegister" class="btn-ghost">Register</button>
        <div class="inline-note" style="margin-top:6px; opacity:.6">still not registered?</div>
      </div>

      <label class="checkbox">
        <input type="checkbox" id="saveLogin" />
        <span>Save login data for fast loading</span>
      </label>
    </section>

    <!-- Register Subpage -->
    <section id="registerPage" class="card stack subpage" aria-hidden="true">
      <div class="row" style="justify-content:space-between; gap:6px;">
        <h1>Create your EMA account</h1>
        <button class="btn-secondary" id="btnBackToLogin" style="width:auto;">← Back</button>
      </div>

      <div style="text-align:center;">
        <button id="btnPickPhoto" class="btn-ghost" style="width:auto;">＋ Upload Profile Picture</button>
        <input type="file" id="photoFile" accept="image/*" class="sr" />
        <div id="photoPreviewWrap" style="margin-top:10px;"></div>
      </div>

      <div class="stack">
        <div>
          <label for="fullName">Full Name</label>
          <input id="fullName" placeholder="Enter your full name" />
          <div id="errName" class="error" style="display:none;">Name must be at least 5 characters.</div>
        </div>
        <div>
          <label for="phone">Phone Number</label>
          <input id="phone" placeholder="+94XX XXX XXXX or 07X XXX XXXX" />
          <div id="errPhone" class="error" style="display:none;">Enter a valid Sri Lankan phone number.</div>
        </div>
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="you@example.com" />
          <div id="errEmail" class="error" style="display:none;">Enter a valid email address.</div>
        </div>

        <div class="grid2">
          <div>
            <label for="province">Province</label>
            <select id="province"></select>
          </div>
          <div>
            <label for="district">District</label>
            <select id="district"><option value="">Select province first</option></select>
          </div>
        </div>
      </div>

      <p class="inline-note" style="margin-top:8px;">
        Please enter only valid and true information. Your account is checked before registering.
      </p>

      <button id="btnDoRegister">Register</button>
    </section>
  </main>

  <!-- Modal: Registering + ID Card -->
  <div class="modal" id="modalRegister">
    <div class="panel stack">
      <button class="close-x" id="closeRegX" title="Close">×</button>
      <h2 id="regStatus">Registering…</h2>
      <div class="idcard-wrap" id="idcardWrap" style="display:none;">
        <canvas id="idcard" width="1000" height="600" aria-label="EMA ID Card Preview"></canvas>
        <div class="row" style="justify-content:center;">
          <a id="downloadCard" class="btn" download="EMA-ID.png">Download Card</a>
          <button id="doneAfterReg" class="btn-secondary" style="width:auto;">Done</button>
        </div>
      </div>
      <div id="yourIdText" class="good" style="display:none;"></div>
    </div>
  </div>

  <!-- Modal: Scanner -->
  <div class="modal" id="modalScan">
    <div class="panel stack">
      <button class="close-x" id="closeScanX" title="Close">×</button>
      <h2>Scan your E-Card</h2>
      <div class="camera-wrap">
        <video id="camera" playsinline muted></video>
        <div class="scan-box" aria-hidden="true"></div>
      </div>
      <p id="scanHint" class="inline-note">Align the card in the box. We’ll try QR first, then Data Matrix.</p>
      <div id="scanMsg" class="muted"></div>
    </div>
  </div>

  <!-- Modal: Forgot ID -->
  <div class="modal" id="modalForgot">
    <div class="panel stack">
      <button class="close-x" id="closeForgotX" title="Close">×</button>
      <h2>Recover your EMA ID</h2>

      <div class="grid2">
        <div>
          <label for="fpProvince">Province</label>
          <select id="fpProvince"></select>
        </div>
        <div>
          <label for="fpDistrict">District</label>
          <select id="fpDistrict"><option value="">Select province first</option></select>
        </div>
      </div>

      <div>
        <label for="fpPhone">Phone Number</label>
        <input id="fpPhone" placeholder="+94XX XXX XXXX or 07X XXX XXXX" />
      </div>

      <button id="btnFindId">Find my ID</button>
      <div id="forgotMsg" class="muted"></div>
    </div>
  </div>

  <!-- Firebase config (from your snippet) -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAIqO8zSyUiYYHe-vBMozYYrQs6Br8rt68",
      authDomain: "project-ema-998cd.firebaseapp.com",
      projectId: "project-ema-998cd",
      storageBucket: "project-ema-998cd.firebasestorage.app",
      messagingSenderId: "356739398551",
      appId: "1:356739398551:web:df3f900d8d7a07c38e22d2",
      measurementId: "G-RHDKXHXFLE"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch {}

    // ---------- App Logic ----------
    const DB_ROOT = "https://project-ema-998cd-default-rtdb.asia-southeast1.firebasedatabase.app";

    // Provinces & Districts (Sri Lanka)
    const PROV_DIST = {
      "Western": ["Colombo","Gampaha","Kalutara"],
      "Central": ["Kandy","Matale","Nuwara Eliya"],
      "Southern": ["Galle","Matara","Hambantota"],
      "Northern": ["Jaffna","Kilinochchi","Mannar","Vavuniya","Mullaitivu"],
      "Eastern": ["Trincomalee","Batticaloa","Ampara"],
      "North Western": ["Kurunegala","Puttalam"],
      "North Central": ["Anuradhapura","Polonnaruwa"],
      "Uva": ["Badulla","Monaragala"],
      "Sabaragamuwa": ["Ratnapura","Kegalle"]
    };

    const $ = (q)=> document.querySelector(q);
    const $$ = (q)=> Array.from(document.querySelectorAll(q));

    const splash = $("#splash");
    const main = $("#main");
    const loginCard = $("#loginCard");
    const registerPage = $("#registerPage");

    const emaId = $("#emaId");
    const btnLogin = $("#btnLogin");
    const btnScan = $("#btnScan");
    const btnRegister = $("#btnRegister");
    const btnForgot = $("#btnForgot");
    const saveLogin = $("#saveLogin");

    const btnBackToLogin = $("#btnBackToLogin");
    const btnPickPhoto = $("#btnPickPhoto");
    const inputPhoto = $("#photoFile");
    const photoPreviewWrap = $("#photoPreviewWrap");

    const fullName = $("#fullName");
    const phone = $("#phone");
    const email = $("#email");
    const province = $("#province");
    const district = $("#district");

    const errName = $("#errName");
    const errPhone = $("#errPhone");
    const errEmail = $("#errEmail");

    const modalRegister = $("#modalRegister");
    const regStatus = $("#regStatus");
    const idcardWrap = $("#idcardWrap");
    const idcardCanvas = $("#idcard");
    const downloadCard = $("#downloadCard");
    const doneAfterReg = $("#doneAfterReg");
    const yourIdText = $("#yourIdText");

    const modalScan = $("#modalScan");
    const camera = $("#camera");
    const closeScanX = $("#closeScanX");
    const scanMsg = $("#scanMsg");

    const modalForgot = $("#modalForgot");
    const closeForgotX = $("#closeForgotX");
    const fpProvince = $("#fpProvince");
    const fpDistrict = $("#fpDistrict");
    const fpPhone = $("#fpPhone");
    const btnFindId = $("#btnFindId");
    const forgotMsg = $("#forgotMsg");

    // Splash → Login
    setTimeout(()=>{ splash.classList.add("hidden"); main.style.display="grid"; }, 2000);

    // Populate provinces
    function fillProvinces(sel) {
      sel.innerHTML = `<option value="">Select Province</option>` +
        Object.keys(PROV_DIST).map(p=>`<option>${p}</option>`).join("");
    }
    function fillDistricts(selProv, selDist) {
      const p = selProv.value;
      selDist.innerHTML = '<option value="">Select District</option>';
      if (p && PROV_DIST[p]) {
        selDist.innerHTML += PROV_DIST[p].map(d=>`<option>${d}</option>`).join("");
      }
    }
    fillProvinces(province);
    fillProvinces(fpProvince);
    province.addEventListener("change", ()=> fillDistricts(province, district));
    fpProvince.addEventListener("change", ()=> fillDistricts(fpProvince, fpDistrict));

    // Photo handling
    btnPickPhoto.addEventListener("click", ()=> inputPhoto.click());
    let profileBlobUrl = null;
    inputPhoto.addEventListener("change", ()=>{
      const f = inputPhoto.files?.[0];
      if (!f) return;
      if (profileBlobUrl) URL.revokeObjectURL(profileBlobUrl);
      profileBlobUrl = URL.createObjectURL(f);
      photoPreviewWrap.innerHTML = `<img src="${profileBlobUrl}" alt="Profile preview" style="width:110px;height:110px;border-radius:999px;object-fit:cover;border:2px solid #e2e8f0; box-shadow:0 6px 16px rgba(2,8,23,.08);" />`;
    });

    // Validators
    const rxName = /^.{5,}$/;
    const rxPhone = /^(?:\+94\d{2}\s?\d{3}\s?\d{4}|0[7]\d\s?\d{3}\s?\d{4})$/;
    const rxEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    function validateRegister() {
      let ok = true;
      errName.style.display = rxName.test(fullName.value.trim()) ? "none" : (ok=false,"block");
      errPhone.style.display = rxPhone.test(phone.value.trim()) ? "none" : (ok=false,"block");
      errEmail.style.display = rxEmail.test(email.value.trim()) ? "none" : (ok=false,"block");
      if (!province.value) { province.focus(); ok=false; }
      if (!district.value) { district.focus(); ok=false; }
      return ok;
    }

    // Navigation between Login ↔ Register subpage
    btnRegister.addEventListener("click", ()=>{
      loginCard.style.display = "none";
      registerPage.style.display = "grid";
      registerPage.setAttribute("aria-hidden", "false");
    });
    btnBackToLogin.addEventListener("click", ()=>{
      registerPage.style.display = "none";
      registerPage.setAttribute("aria-hidden", "true");
      loginCard.style.display = "grid";
    });

    // Generate EMA ID like XXXXXX-E (numbers only prefix)
    function generateEmaId() {
      const n = Math.floor(100000 + Math.random()*900000); // 6 digits
      return `${n}-E`;
    }

    // Draw ID Card (canvas) and return blob url for download
    async function drawIdCard({id, name, phone, email, province, district, photoUrl}) {
      const c = idcardCanvas;
      const ctx = c.getContext("2d");

      // Clear
      ctx.clearRect(0,0,c.width,c.height);

      // Background
      const grad = ctx.createLinearGradient(0,0,c.width,0);
      grad.addColorStop(0, "#f8fafc");
      grad.addColorStop(1, "#eef2ff");
      ctx.fillStyle = grad;
      roundRect(ctx, 0,0,c.width,c.height,24, true, false);

      // Header bar
      ctx.fillStyle = "#0ea5e9";
      roundRect(ctx, 0,0,c.width,120,24, true, false);
      ctx.fillStyle = "#fff";
      ctx.font = "bold 44px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText("EMA — Elephant Monitoring App", 28, 76);

      // Profile
      if (photoUrl) {
        const img = await loadImage(photoUrl);
        // circle crop
        const cx = 120, cy = 260, r = 90;
        ctx.save();
        ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.closePath(); ctx.clip();
        ctx.drawImage(img, cx-r, cy-r, r*2, r*2);
        ctx.restore();
        // circle ring
        ctx.strokeStyle = "#0ea5e9"; ctx.lineWidth = 6;
        ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.stroke();
      }

      // Text fields
      ctx.fillStyle = "#0f172a";
      ctx.font = "bold 40px system-ui";
      ctx.fillText(name || "", 240, 230);
      ctx.font = "24px system-ui";
      ctx.fillText(`ID: ${id}`, 240, 270);
      ctx.fillText(`Phone: ${phone}`, 240, 310);
      ctx.fillText(`Email: ${email}`, 240, 350);
      ctx.fillText(`Province: ${province}`, 240, 390);
      ctx.fillText(`District: ${district}`, 240, 430);

      // QR (right)
      const qrCanvas = document.createElement("canvas");
      await new Promise((res, rej)=> QRCode.toCanvas(qrCanvas, id, {width:240, margin:1}, (e)=> e?rej(e):res()));
      ctx.drawImage(qrCanvas, c.width-280, 160, 220, 220);

      // DataMatrix (bottom)
      const dmCanvas = document.createElement("canvas");
      try {
        BWIPJS.toCanvas(dmCanvas, {
          bcid: 'datamatrix',
          text: id,
          scale: 3,
          padding: 0
        });
        // bottom center
        ctx.drawImage(dmCanvas, (c.width - dmCanvas.width)/2, c.height-dmCanvas.height-24);
      } catch(e) {
        // ignore if failed
      }

      // Footer line
      ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(24, 460); ctx.lineTo(c.width-24, 460); ctx.stroke();
      ctx.fillStyle = "#64748b"; ctx.font="20px system-ui";
      ctx.fillText("Show this card or scan the codes to log in quickly.", 28, 494);

      // Prepare download link
      const blob = await new Promise(res=> c.toBlob(res, "image/png", 0.95));
      const url = URL.createObjectURL(blob);
      downloadCard.href = url;
      return url;
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke){
      if (typeof r === 'number') r = {tl:r,tr:r,br:r,bl:r};
      ctx.beginPath();
      ctx.moveTo(x+r.tl, y);
      ctx.lineTo(x+w-r.tr, y);
      ctx.quadraticCurveTo(x+w, y, x+w, y+r.tr);
      ctx.lineTo(x+w, y+h-r.br);
      ctx.quadraticCurveTo(x+w, y+h, x+w-r.br, y+h);
      ctx.lineTo(x+r.bl, y+h);
      ctx.quadraticCurveTo(x, y+h, x, y+h-r.bl);
      ctx.lineTo(x, y+r.tl);
      ctx.quadraticCurveTo(x, y, x+r.tl, y);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }
    function loadImage(src){
      return new Promise((res, rej)=>{ const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>res(i); i.onerror=rej; i.src=src; });
    }

    // Register → store in Firebase Realtime DB under /users/{XXXXXX-E}
    $("#btnDoRegister").addEventListener("click", async ()=>{
      if (!validateRegister()) return;

      modalRegister.classList.add("open");
      regStatus.textContent = "Registering…";
      idcardWrap.style.display = "none";
      yourIdText.style.display = "none";

      const id = generateEmaId();
      // Prepare data
      const data = {
        id,
        name: fullName.value.trim(),
        phone: phone.value.trim(),
        email: email.value.trim(),
        province: province.value,
        district: district.value,
        createdAt: new Date().toISOString()
      };

      // Upload profile photo to base64 (store inline under user for demo purposes)
      if (profileBlobUrl) {
        const b64 = await fetch(profileBlobUrl).then(r=>r.blob()).then(b=> blobToDataURL(b));
        data.photo = b64;
      }

      try {
        // Save at /users/{id}.json
        const resp = await fetch(`${DB_ROOT}/users/${encodeURIComponent(id)}.json`, {
          method: "PUT",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(data)
        });
        if (!resp.ok) throw new Error("Failed to save user");

        regStatus.textContent = `"${id}" is your ID for logging into EMA`;
        yourIdText.textContent = `${id} is your ID for logging into EMA`;
        yourIdText.style.display = "block";

        // Build card
        const photoUrl = data.photo ? data.photo : profileBlobUrl;
        await drawIdCard({
          id,
          name: data.name,
          phone: data.phone,
          email: data.email,
          province: data.province,
          district: data.district,
          photoUrl
        });

        idcardWrap.style.display = "grid";
      } catch (e) {
        regStatus.textContent = "Registration failed. Please try again.";
      }
    });

    function blobToDataURL(blob){
      return new Promise((res)=>{
        const r = new FileReader();
        r.onload = ()=> res(r.result);
        r.readAsDataURL(blob);
      });
    }

    doneAfterReg.addEventListener("click", ()=>{
      modalRegister.classList.remove("open");
      // Go back to login with prefilled ID?
      // Keep on login page.
    });
    $("#closeRegX").addEventListener("click", ()=> modalRegister.classList.remove("open"));

    // Scanner (QR → Data Matrix)
    let codeReader = null;
    let currentStream = null;
    btnScan.addEventListener("click", async ()=>{
      modalScan.classList.add("open");
      scanMsg.textContent = "Opening camera…";
      try {
        codeReader = new ZXing.BrowserMultiFormatReader();
        const videoInputDevices = await ZXing.BrowserCodeReader.listVideoInputDevices();
        // Prefer environment camera
        const backCam = videoInputDevices.find(d => /back|rear|environment/i.test(d.label)) || videoInputDevices[0];

        const constraints = {
          audio: false,
          video: backCam ? { deviceId: backCam.deviceId, facingMode: "environment" } : { facingMode: "environment" }
        };
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        camera.srcObject = currentStream;
        await camera.play();

        scanMsg.textContent = "Scanning…";
        // Decode loop (accept QR or Data Matrix)
        codeReader.decodeFromVideoElement(camera, (result, err) => {
          if (result) {
            const text = (result.getText ? result.getText() : result.text) || "";
            if (/^\d{6}-E$/.test(text)) {
              stopCamera();
              modalScan.classList.remove("open");
              emaId.value = text;
            } else {
              scanMsg.textContent = "Code detected but not an EMA ID. Keep aligning…";
            }
          } else if (err) {
            // keep trying silently
          }
        });
      } catch (e) {
        scanMsg.textContent = "Could not access camera. Check permissions.";
      }
    });

    function stopCamera(){
      try {
        if (codeReader) { codeReader.reset(); codeReader = null; }
        if (currentStream) {
          currentStream.getTracks().forEach(t=>t.stop());
          currentStream = null;
        }
      } catch {}
    }
    closeScanX.addEventListener("click", ()=> { stopCamera(); modalScan.classList.remove("open"); });

    // Forgot ID
    btnForgot.addEventListener("click", ()=> {
      modalForgot.classList.add("open");
      forgotMsg.textContent = "";
    });
    closeForgotX.addEventListener("click", ()=> modalForgot.classList.remove("open"));
    btnFindId.addEventListener("click", async ()=>{
      const p = fpProvince.value;
      const d = fpDistrict.value;
      const ph = fpPhone.value.trim();
      if (!rxPhone.test(ph) || !p || !d){
        forgotMsg.textContent = "Please fill all fields with valid values.";
        return;
      }
      forgotMsg.textContent = "Searching…";
      try {
        const res = await fetch(`${DB_ROOT}/users.json`);
        const data = await res.json() || {};
        const found = Object.values(data).find(u => u.phone === ph && u.province === p && u.district === d);
        if (found) {
          forgotMsg.innerHTML = `<span class="good">Found your ID:</span> <strong>${found.id}</strong>`;
        } else {
          forgotMsg.innerHTML = `<span class="error">ID number not found. Try aligning the card and rescanning.</span>`;
        }
      } catch (e) {
        forgotMsg.textContent = "Could not query database. Try again.";
      }
    });

    // Login
    btnLogin.addEventListener("click", ()=>{
      const id = emaId.value.trim().toUpperCase();
      if (!/^\d{6}-E$/.test(id)) {
        alert("Please enter a valid EMA ID like 123456-E");
        return;
      }
      if (saveLogin.checked) {
        try {
          localStorage.setItem("ema_id", id);
          document.cookie = `ema_id=${encodeURIComponent(id)}; path=/; max-age=${60*60*24*365}`;
        } catch {}
      }
      // Redirect to home.html with ID number signaled
      location.href = `home.html?id=${encodeURIComponent(id)}`;
    });

    // Auto-fill saved ID if present
    (function prefillId(){
      try {
        const saved = localStorage.getItem("ema_id") || (document.cookie.match(/(?:^|;\s*)ema_id=([^;]+)/) || [])[1];
        if (saved) { emaId.value = decodeURIComponent(saved); saveLogin.checked = true; }
      } catch {}
    })();

    // Basic UX: Enter to login
    emaId.addEventListener("keydown", (e)=>{ if (e.key === "Enter") btnLogin.click(); });
  </script>

  <!-- Accessibility hint for keyboard users -->
  <script>
    // When Register button clicked from keyboard, focus first field
    document.getElementById("btnRegister").addEventListener("click", ()=>{
      setTimeout(()=> document.getElementById("fullName").focus(), 50);
    });
  </script>
</body>
</html>
