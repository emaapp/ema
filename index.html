<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA - Elephant Monitoring App</title>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js")
      .then(() => console.log("Service Worker Registered"))
      .catch(err => console.error("SW reg failed", err));
  }
</script>

    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        .hidden { display: none; }
        .fade-out {
            animation: fadeOut 1s forwards;
            animation-delay: 1.5s;
        }
        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }
        .fade-in {
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .popup-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            width: 24px;
            height: 24px;
        }
        #scanner-container {
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #reader {
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="splash-screen" class="fixed inset-0 bg-white flex flex-col justify-center items-center z-50">
        <img src="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png" alt="EMA Logo" class="w-32 h-32 mb-4">
        <h1 class="text-3xl font-bold text-gray-700">EMA</h1>
        <p class="text-gray-500">Elephant Monitoring App</p>
    </div>

    <main id="app-container" class="min-h-screen flex items-center justify-center p-4 opacity-0 transition-opacity duration-500">
        <div class="w-full max-w-md">

            <div id="login-page" class="bg-white p-8 rounded-2xl shadow-lg w-full fade-in">
                <div class="text-center mb-8">
                    <img src="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png" alt="EMA Logo" class="w-20 h-20 mx-auto mb-2">
                    <h2 class="text-2xl font-bold">Welcome to EMA</h2>
                </div>
                
                <div>
                    <label for="ema-id" class="block text-sm font-medium text-gray-700 mb-1">EMA ID</label>
                    <input type="text" id="ema-id" placeholder="XXXXXX-E" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <button id="login-btn" class="w-full bg-blue-600 text-white py-2 mt-4 rounded-lg hover:bg-blue-700 font-semibold transition shadow">Login</button>
                
                <div class="flex items-center my-6">
                    <hr class="flex-grow border-t border-gray-300">
                    <span class="mx-4 text-gray-400 text-sm">or</span>
                    <hr class="flex-grow border-t border-gray-300">
                </div>

                <button id="scan-card-btn" class="w-full bg-gray-800 text-white py-2 rounded-lg hover:bg-gray-900 font-semibold transition shadow mb-4">Scan the E-Card</button>

                <div class="text-center">
                    <p class="text-sm text-gray-400 mb-2">Still not registered?</p>
                    <div class="flex gap-4">
                        <button id="show-register-btn" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 font-semibold transition shadow">Register</button>
                        <button id="forgot-id-btn" class="flex-1 bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600 font-semibold transition shadow">Forgot ID</button>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <label class="flex items-center justify-center text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" id="save-login-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2">Save login data for fast loading</span>
                    </label>
                </div>
            </div>

            <div id="register-page" class="bg-white p-8 rounded-2xl shadow-lg w-full hidden fade-in">
                 <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold">Create Your Account</h2>
                </div>
                <div class="flex justify-center mb-4">
                     <label for="profile-picture-upload" class="cursor-pointer">
                        <div id="profile-picture-preview" class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center border-2 border-dashed border-gray-300">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        </div>
                    </label>
                    <input type="file" id="profile-picture-upload" accept="image/*" class="hidden">
                </div>
                <div class="space-y-4">
                    <input type="text" id="reg-name" placeholder="Full Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="reg-phone" placeholder="Phone Number (+94XXXXXXXXX)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="email" id="reg-email" placeholder="Email Address" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <select id="reg-province" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="">Select Province</option>
                    </select>
                    <select id="reg-district" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="">Select District</option>
                    </select>
                </div>
                <p class="text-xs text-center text-gray-500 mt-4">Please enter only valid and true information. Your account is checked before registering.</p>
                <button id="register-submit-btn" class="w-full bg-green-600 text-white py-2 mt-6 rounded-lg hover:bg-green-700 font-semibold transition shadow">Register</button>
                <button id="back-to-login-btn" class="w-full text-gray-600 py-2 mt-2 rounded-lg hover:bg-gray-100 font-semibold transition">Back to Login</button>
            </div>
        </div>
    </main>
    
    <div id="message-popup" class="popup-overlay hidden">
        <div class="popup-content text-center">
            <p id="message-text" class="mb-4"></p>
            <button onclick="hidePopup('message-popup')" class="bg-blue-600 text-white px-6 py-2 rounded-lg">OK</button>
        </div>
    </div>
    
    <div id="registration-success-popup" class="popup-overlay hidden">
        <div class="popup-content">
            <div id="registering-loader" class="text-center">
                <div role="status">
                    <svg aria-hidden="true" class="inline w-8 h-8 text-gray-200 animate-spin dark:text-gray-600 fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                        <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                    </svg>
                    <span class="sr-only">Loading...</span>
                </div>
                <p>Registering...</p>
            </div>
            <div id="e-card-container" class="hidden text-center">
                 <p class="font-semibold mb-2" id="id-display-text"></p>
                 <div id="e-card" class="p-4 border rounded-lg bg-gray-50 mb-4 shadow-inner">
                    <div class="flex items-center space-x-4">
                        <img id="card-profile-pic" class="w-20 h-20 rounded-full border-2 border-blue-500 object-cover" src="" alt="Profile Picture">
                        <div class="text-left">
                            <p id="card-name" class="font-bold text-lg"></p>
                            <p id="card-phone" class="text-sm text-gray-600"></p>
                            <p id="card-location" class="text-sm text-gray-600"></p>
                        </div>
                        <div id="card-qrcode" class="ml-auto"></div>
                    </div>
                    <div class="mt-4 flex justify-center">
                        <svg id="card-barcode"></svg>
                    </div>
                 </div>
                 <button id="download-card-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg mr-2">Download</button>
                 <button id="registration-done-btn" class="bg-gray-600 text-white px-6 py-2 rounded-lg">Done</button>
            </div>
        </div>
    </div>
    
    <div id="scanner-popup" class="popup-overlay hidden">
        <div class="popup-content">
            <svg class="close-btn text-gray-500 hover:text-gray-800" onclick="hidePopup('scanner-popup')" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            <h3 class="text-xl font-semibold mb-4 text-center">Scan E-Card</h3>
            <div id="scanner-container">
                 <div id="reader"></div>
            </div>
            <p id="scanner-message" class="text-center text-sm text-red-500 mt-2"></p>
        </div>
    </div>

    <div id="forgot-id-popup" class="popup-overlay hidden">
        <div class="popup-content">
            <svg class="close-btn text-gray-500 hover:text-gray-800" onclick="hidePopup('forgot-id-popup')" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            <h3 class="text-xl font-semibold mb-4 text-center">Find Your ID</h3>
            <div class="space-y-4">
                <input type="text" id="forgot-phone" placeholder="Phone Number" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <select id="forgot-province" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                    <option value="">Select Province</option>
                </select>
                <select id="forgot-district" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                    <option value="">Select District</option>
                </select>
            </div>
            <button id="find-id-btn" class="w-full bg-blue-600 text-white py-2 mt-6 rounded-lg">Find ID</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAIqO8zSyUiYYHe-vBMozYYrQs6Br8rt68",
            authDomain: "project-ema-998cd.firebaseapp.com",
            databaseURL: "https://project-ema-998cd-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "project-ema-998cd",
            storageBucket: "project-ema-998cd.firebasestorage.app",
            messagingSenderId: "356739398551",
            appId: "1:356739398551:web:df3f900d8d7a07c38e22d2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const provincesAndDistricts = {
            "Western": ["Colombo", "Gampaha", "Kalutara"],
            "Central": ["Kandy", "Matale", "Nuwara Eliya"],
            "Southern": ["Galle", "Matara", "Hambantota"],
            "Northern": ["Jaffna", "Kilinochchi", "Mannar", "Vavuniya", "Mullaitivu"],
            "Eastern": ["Trincomalee", "Batticaloa", "Ampara"],
            "North Western": ["Kurunegala", "Puttalam"],
            "North Central": ["Anuradhapura", "Polonnaruwa"],
            "Uva": ["Badulla", "Monaragala"],
            "Sabaragamuwa": ["Ratnapura", "Kegalle"]
        };

        const provinceSelect = document.getElementById('reg-province');
        const districtSelect = document.getElementById('reg-district');
        const forgotProvinceSelect = document.getElementById('forgot-province');
        const forgotDistrictSelect = document.getElementById('forgot-district');
        const appContainer = document.getElementById('app-container');

        window.showPopup = (id, message) => {
            if(id === 'message-popup') {
                document.getElementById('message-text').innerText = message;
            }
            document.getElementById(id).classList.remove('hidden');
        };

        window.hidePopup = (id) => {
            document.getElementById(id).classList.add('hidden');
            if (id === 'scanner-popup' && window.html5QrcodeScanner) {
                window.html5QrcodeScanner.stop()
                    .catch(err => {
                        console.log("Scanner could not be stopped, likely already inactive.");
                    });
            }
        };

        function populateProvinces(selectElement) {
            Object.keys(provincesAndDistricts).forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                selectElement.appendChild(option);
            });
        }
        
        function populateDistricts(province, selectElement) {
            selectElement.innerHTML = '<option value="">Select District</option>';
            if (province && provincesAndDistricts[province]) {
                provincesAndDistricts[province].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    selectElement.appendChild(option);
                });
            }
        }
        
        function switchPage(page) {
            const loginPage = document.getElementById('login-page');
            const registerPage = document.getElementById('register-page');
            if (page === 'register') {
                loginPage.classList.add('hidden');
                registerPage.classList.remove('hidden');
            } else {
                registerPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
            }
        }

        function validateForm() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const email = document.getElementById('reg-email').value;
            const province = document.getElementById('reg-province').value;
            const district = document.getElementById('reg-district').value;
            const profilePic = document.getElementById('profile-picture-upload').files[0];

            if (!profilePic) {
                showPopup('message-popup', 'Please upload a profile picture.');
                return false;
            }
            if (name.length < 5) {
                showPopup('message-popup', 'Full name must be at least 5 characters long.');
                return false;
            }
            const phoneRegex = /^(?:\+94|0)?(7[0-9]{8})$/;
            if (!phoneRegex.test(phone.replace(/\s/g, ''))) {
                showPopup('message-popup', 'Please enter a valid Sri Lankan phone number.');
                return false;
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showPopup('message-popup', 'Please enter a valid email address.');
                return false;
            }
            if (!province || !district) {
                showPopup('message-popup', 'Please select your province and district.');
                return false;
            }
            return true;
        }

        async function registerUser() {
            if (!validateForm()) return;

            showPopup('registration-success-popup');
            document.getElementById('registering-loader').classList.remove('hidden');
            document.getElementById('e-card-container').classList.add('hidden');

            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const email = document.getElementById('reg-email').value;
            const province = document.getElementById('reg-province').value;
            const district = document.getElementById('reg-district').value;
            const profilePicFile = document.getElementById('profile-picture-upload').files[0];
            
            const reader = new FileReader();
            reader.readAsDataURL(profilePicFile);
            reader.onload = async () => {
                const profilePicBase64 = reader.result;
                let newId;
                let idExists = true;
                
                while(idExists) {
                    const randomNum = Math.floor(100000 + Math.random() * 900000);
                    newId = `${randomNum}-E`;
                    const snapshot = await get(child(ref(db), `users/${newId}`));
                    idExists = snapshot.exists();
                }

                const userData = { name, phone, email, province, district, profilePic: profilePicBase64 };

                try {
                    await set(ref(db, `users/${newId}`), userData);

                    document.getElementById('id-display-text').innerText = `${newId} is your ID for logging into EMA`;
                    document.getElementById('card-profile-pic').src = profilePicBase64;
                    document.getElementById('card-name').innerText = name;
                    document.getElementById('card-phone').innerText = phone;
                    document.getElementById('card-location').innerText = `${district}, ${province}`;

                    document.getElementById('card-qrcode').innerHTML = '';
                    new QRCode(document.getElementById("card-qrcode"), {
                        text: newId,
                        width: 64,
                        height: 64
                    });
                    
                    JsBarcode("#card-barcode", newId, {
                        format: "CODE128",
                        height: 40,
                        displayValue: false
                    });
                    
                    document.getElementById('registering-loader').classList.add('hidden');
                    document.getElementById('e-card-container').classList.remove('hidden');
                } catch (error) {
                    hidePopup('registration-success-popup');
                    showPopup('message-popup', 'Registration failed. Please try again.');
                }
            };
            reader.onerror = () => {
                hidePopup('registration-success-popup');
                showPopup('message-popup', 'Failed to read profile picture.');
            };
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const savedId = localStorage.getItem('emaUserId');
            if (savedId) {
                // If ID is saved, redirect immediately. The splash screen will cover this.
                window.location.href = `home.html?id=${savedId}`;
            } else {
                // Otherwise, fade out the splash screen and show the login page.
                const splash = document.getElementById('splash-screen');
                splash.classList.add('fade-out');
                setTimeout(() => {
                    splash.style.pointerEvents = 'none';
                    appContainer.style.opacity = '1';
                }, 1000); // Shorten fadeout for quicker access if not logged in
            }

            populateProvinces(provinceSelect);
            populateProvinces(forgotProvinceSelect);
        });
        
        provinceSelect.addEventListener('change', (e) => populateDistricts(e.target.value, districtSelect));
        forgotProvinceSelect.addEventListener('change', (e) => populateDistricts(e.target.value, forgotDistrictSelect));

        document.getElementById('show-register-btn').addEventListener('click', () => switchPage('register'));
        document.getElementById('back-to-login-btn').addEventListener('click', () => switchPage('login'));

        document.getElementById('profile-picture-upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('profile-picture-preview');
                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full rounded-full object-cover">`;
                }
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('register-submit-btn').addEventListener('click', registerUser);

        document.getElementById('download-card-btn').addEventListener('click', () => {
            const cardElement = document.getElementById('e-card');
            html2canvas(cardElement).then(canvas => {
                const link = document.createElement('a');
                link.download = 'ema-e-card.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        });
        
        document.getElementById('registration-done-btn').addEventListener('click', () => {
            hidePopup('registration-success-popup');
            switchPage('login');
        });

        document.getElementById('scan-card-btn').addEventListener('click', () => {
            showPopup('scanner-popup');
            const html5QrCode = new Html5Qrcode("reader");
            window.html5QrcodeScanner = html5QrCode;
            document.getElementById('scanner-message').innerText = '';
            
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('ema-id').value = decodedText;
                html5QrCode.stop().then(ignore => {
                    hidePopup('scanner-popup');
                }).catch(err => console.log(err));
            };
            const config = { fps: 10, qrbox: { width: 250, height: 150 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
            .catch(err => {
                document.getElementById('scanner-message').innerText = 'Camera permission is required.';
            });
        });

        document.getElementById('forgot-id-btn').addEventListener('click', () => showPopup('forgot-id-popup'));
        
        document.getElementById('find-id-btn').addEventListener('click', async () => {
            const phone = document.getElementById('forgot-phone').value;
            const province = document.getElementById('forgot-province').value;
            const district = document.getElementById('forgot-district').value;

            if(!phone || !province || !district) {
                showPopup('message-popup', 'Please fill all fields to find your ID.');
                return;
            }

            try {
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                let foundId = null;

                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const userData = childSnapshot.val();
                        if (userData.phone === phone && userData.province === province && userData.district === district) {
                            foundId = childSnapshot.key;
                        }
                    });
                }
                
                if(foundId) {
                    hidePopup('forgot-id-popup');
                    showPopup('message-popup', `Your EMA ID is: ${foundId}`);
                } else {
                    showPopup('message-popup', 'No matching account found. Please check your details.');
                }
            } catch (error) {
                showPopup('message-popup', 'Error searching for ID. Please try again.');
            }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const emaId = document.getElementById('ema-id').value;
            if(!emaId) {
                showPopup('message-popup', 'Please enter your EMA ID.');
                return;
            }

            try {
                const snapshot = await get(child(ref(db), `users/${emaId}`));
                if(snapshot.exists()) {
                    if(document.getElementById('save-login-checkbox').checked) {
                        // Using localStorage instead of cookies for simplicity in this context
                        localStorage.setItem('emaUserId', emaId);
                    } else {
                        localStorage.removeItem('emaUserId');
                    }
                    showPopup('message-popup', `Login successful! Redirecting...`);
                    setTimeout(() => {
                        window.location.href = `home.html?id=${emaId}`;
                    }, 1500);
                } else {
                    showPopup('message-popup', 'Invalid EMA ID. Please check and try again.');
                }
            } catch (error) {
                showPopup('message-popup', 'An error occurred during login. Please try again.');
            }
        });

    </script>
</body>
</html>

