<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EMA â€” Elephant Monitoring App</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #0f172a; /* slate-900 */
      --muted: #64748b; /* slate-500 */
      --primary: #0ea5e9; /* sky-500 */
      --primary-600: #0284c7; /* sky-600 */
      --border: #e5e7eb; /* gray-200 */
      --card: #f8fafc; /* slate-50 */
      --success: #16a34a; /* green-600 */
      --danger: #ef4444; /* red-500 */
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* Centered mobile-first layout */
    .container {
      min-height: 100dvh;
      display: grid;
      place-items: center;
      padding: 24px;
    }

    .card {
      width: min(520px, 94vw);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 10px 30px rgba(2, 8, 23, 0.06);
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 1.6rem;
      letter-spacing: -0.02em;
    }

    .subtitle { color: var(--muted); margin-bottom: 18px; }

    .row { display: grid; gap: 12px; margin: 12px 0; }

    label { font-size: .9rem; font-weight: 600; }

    input[type="text"], input[type="email"], input[type="tel"], select {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
      font-size: 1rem;
      outline: none;
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(14,165,233,.15); }

    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn:hover { box-shadow: 0 6px 16px rgba(2, 8, 23, 0.06); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(180deg, var(--primary), var(--primary-600)); color: #fff; border-color: transparent; }
    .btn.ghost { background: #fff; }
    .btn.full { width: 100%; }
    .btn.muted { color: var(--muted); }

    .hr-with-text { display: grid; grid-template-columns: 1fr auto 1fr; place-items: center; gap: 8px; margin: 16px 0; color: var(--muted); }
    .hr-with-text::before, .hr-with-text::after { content: ""; height: 1px; background: var(--border); width: 100%; }

    .inline { display: flex; align-items: center; gap: 10px; }
    .muted { color: var(--muted); }

    .checkbox { display: inline-flex; align-items: center; gap: 10px; user-select: none; }
    .checkbox input { width: 18px; height: 18px; }

    /* Splash */
    #splash {
      position: fixed; inset: 0; background: #fff; display: grid; place-items: center; z-index: 50;
      transition: opacity .5s ease; opacity: 1;
    }
    #splash.fade { opacity: 0; pointer-events: none; }
    .splash-card { text-align: center; }
    .splash-logo { width: 84px; height: 84px; border-radius: 20px; }
    .splash-title { font-weight: 900; margin-top: 12px; font-size: 1.5rem; }
    .splash-ad { margin-top: 8px; color: var(--muted); font-size: .95rem; }

    /* Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 40; }
    .modal.open { display: flex; }
    .modal .backdrop { position: absolute; inset: 0; background: rgba(2,8,23,.4); }
    .modal .panel { position: relative; width: min(680px, 94vw); max-height: 90vh; overflow: auto; background: #fff; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(2,8,23,.25); padding: 22px; }
    .modal .close { position: absolute; right: 12px; top: 12px; background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 6px 10px; cursor: pointer; }

    /* Register Subpage */
    #registerView { display: none; }
    #registerView.show { display: block; }

    .avatar-uploader { display: grid; place-items: center; padding: 14px; border: 1px dashed var(--border); border-radius: 16px; background: #fff; cursor: pointer; }
    .avatar-uploader img { width: 96px; height: 96px; border-radius: 999px; object-fit: cover; display: block; }
    .avatar-uploader .plus { width: 96px; height: 96px; border-radius: 999px; display: grid; place-items: center; background: var(--card); font-size: 2rem; color: var(--muted); border: 1px solid var(--border); }

    /* Camera Scan */
    .scan-frame { position: relative; }
    .scan-video { width: 100%; border-radius: 16px; background: #000; }
    .scan-overlay { position: absolute; inset: 0; border-radius: 16px; pointer-events: none; }
    .scan-box { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 80%; aspect-ratio: 16/9; border: 3px solid rgba(14,165,233,.9); border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0,0,0,.4); }

    /* Toast */
    .toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: #111827; color: #fff; padding: 12px 16px; border-radius: 12px; display: none; z-index: 60; }
    .toast.show { display: block; }

    /* ID Card preview */
    .idcard-wrap { display: grid; gap: 8px; }
    .idcard-actions { display: flex; gap: 10px; flex-wrap: wrap; }

    /* Helpers */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Splash (2 seconds) -->
  <div id="splash">
    <div class="splash-card">
      <img class="splash-logo" src="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png" alt="EMA logo"/>
      <div class="splash-title">EMA â€” Elephant Monitoring App</div>
      <div class="splash-ad">ðŸŒ¿ Protecting giants. Loadingâ€¦</div>
    </div>
  </div>

  <div class="container">
    <div class="card" id="loginCard">
      <header>
        <h1>Welcome to EMA</h1>
        <div class="subtitle">Secure monitoring for field teams</div>
      </header>

      <!-- Login View -->
      <div id="loginView">
        <div class="row">
          <label for="emaId">EMA ID</label>
          <input id="emaId" type="text" inputmode="text" placeholder="XXXXXX-E" autocomplete="one-time-code" />
        </div>
        <button id="btnLogin" class="btn primary full">Login</button>

        <div class="hr-with-text">â€” or â€”</div>

        <div class="row">
          <button id="btnScan" class="btn full">Scan the Eâ€‘Card</button>
          <div class="muted" style="text-align:center; font-size:.92rem; opacity:.7;">still not registered?</div>
          <div class="inline" style="justify-content:center; flex-wrap: wrap; gap: 10px;">
            <button id="btnOpenRegister" class="btn ghost">Register</button>
            <button id="btnForgot" class="btn ghost">Forgot ID</button>
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <label class="checkbox"><input id="saveLogin" type="checkbox"/> <span>Save login data for fast loading</span></label>
        </div>
      </div>

      <!-- Register Subpage -->
      <div id="registerView">
        <h2 style="margin:0 0 8px 0;">Create your EMA account</h2>
        <div class="subtitle">Please enter only valid and true information. Your account is checked before registering.</div>

        <div class="row">
          <label>Profile Picture</label>
          <div id="avatarDrop" class="avatar-uploader">
            <div class="plus">+</div>
            <img id="avatarPreview" class="hidden" alt="Profile preview" />
            <input id="avatarInput" type="file" accept="image/*" class="hidden"/>
          </div>
        </div>

        <div class="row"><label for="fullName">Full Name</label><input id="fullName" type="text" placeholder="At least 5 characters" minlength="5"/></div>
        <div class="row"><label for="phone">Phone Number</label><input id="phone" type="tel" placeholder="+94XX XXX XXXX or 07X XXX XXXX"/></div>
        <div class="row"><label for="email">Email</label><input id="email" type="email" placeholder="you@example.com"/></div>

        <div class="row">
          <label for="province">Province</label>
          <select id="province"></select>
        </div>
        <div class="row">
          <label for="district">District</label>
          <select id="district"><option value="">Select a province first</option></select>
        </div>

        <div class="row" style="margin-top: 6px;">
          <button id="btnRegister" class="btn primary full">Register</button>
          <button id="btnBackToLogin" class="btn full">Back to Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div class="modal" id="scanModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel">
      <button class="close" id="scanClose">âœ•</button>
      <h3 style="margin-top:0;">Scan your EMA Eâ€‘Card</h3>
      <div class="scan-frame">
        <video id="scanVideo" class="scan-video" autoplay playsinline></video>
        <canvas id="scanCanvas" class="hidden"></canvas>
        <div class="scan-overlay">
          <div class="scan-box"></div>
        </div>
      </div>
      <div id="scanStatus" class="muted" style="margin-top:10px;">Align the card inside the box. Scanning QR/Data Matrixâ€¦</div>
    </div>
  </div>

  <!-- Generic Modal for Registering & ID Card -->
  <div class="modal" id="registerModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel">
      <button class="close" id="regClose">âœ•</button>
      <div id="registering">
        <h3 style="margin-top:0;">Registeringâ€¦</h3>
        <div class="muted">Please wait while we save your details securely.</div>
      </div>
      <div id="idCardSection" class="hidden">
        <h3 style="margin: 0 0 6px 0;">Your EMA ID</h3>
        <div id="yourIdText" style="font-weight:700; margin-bottom:8px;"></div>
        <div class="idcard-wrap">
          <canvas id="idCardCanvas" width="880" height="520" style="width:100%; border-radius:16px; border:1px solid var(--border);"></canvas>
          <div class="idcard-actions">
            <button id="btnDownloadCard" class="btn">Download as PNG</button>
            <button id="btnDone" class="btn primary">Done</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Forgot ID Modal -->
  <div class="modal" id="forgotModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel">
      <button class="close" id="forgotClose">âœ•</button>
      <h3 style="margin-top:0;">Recover your ID</h3>
      <div class="row"><label for="forgotPhone">Phone Number</label><input id="forgotPhone" type="tel" placeholder="+94XX XXX XXXX or 07X XXX XXXX"/></div>
      <div class="row"><label for="forgotProvince">Province</label><select id="forgotProvince"></select></div>
      <div class="row"><label for="forgotDistrict">District</label><select id="forgotDistrict"><option value="">Select a province first</option></select></div>
      <div class="row"><button id="btnFindId" class="btn primary full">Find my ID</button></div>
      <div id="forgotResult" class="muted"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- External libs for codes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-Mw46Xo9dOmCGHMMsDffmJ2h/hlkPCF1kqv3Z6JtniGv5gYkrHBIKk4nU1WOrhW8W5m8b+7mJf5vEW8Xc1Y0A4w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/bwip-js@3.4.3/dist/bwip-js-min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    // Config (provided)
    const firebaseConfig = {
      apiKey: "AIzaSyAIqO8zSyUiYYHe-vBMozYYrQs6Br8rt68",
      authDomain: "project-ema-998cd.firebaseapp.com",
      projectId: "project-ema-998cd",
      storageBucket: "project-ema-998cd.firebasestorage.app",
      messagingSenderId: "356739398551",
      appId: "1:356739398551:web:df3f900d8d7a07c38e22d2",
      measurementId: "G-RHDKXHXFLE",
      databaseURL: "https://project-ema-998cd-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch (_) {}
    const db = getDatabase(app);

    // --- UI helpers ---
    const $ = (sel) => document.querySelector(sel);
    const toast = (msg, ms=2200) => { const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms); };
    const openModal = (id) => $(id).classList.add('open');
    const closeModal = (id) => $(id).classList.remove('open');

    // Splash fade after 2s
    window.addEventListener('load', () => {
      setTimeout(()=> $('#splash').classList.add('fade'), 2000);
    });

    // Province/District data (Sri Lanka)
    const PROVINCES = {
      "Central": ["Kandy","Matale","Nuwara Eliya"],
      "Eastern": ["Ampara","Batticaloa","Trincomalee"],
      "North Central": ["Anuradhapura","Polonnaruwa"],
      "Northern": ["Jaffna","Kilinochchi","Mannar","Mullaitivu","Vavuniya"],
      "North Western": ["Kurunegala","Puttalam"],
      "Sabaragamuwa": ["Kegalle","Ratnapura"],
      "Southern": ["Galle","Hambantota","Matara"],
      "Uva": ["Badulla","Monaragala"],
      "Western": ["Colombo","Gampaha","Kalutara"]
    };

    function fillProvinces(selectEl){
      selectEl.innerHTML = '<option value="">Select province</option>' + Object.keys(PROVINCES).map(p=>`<option value="${p}">${p}</option>`).join('');
    }
    function fillDistricts(selectEl, province){
      const list = PROVINCES[province] || [];
      selectEl.innerHTML = list.length ? list.map(d=>`<option value="${d}">${d}</option>`).join('') : '<option value="">Select a province first</option>';
    }

    // Elements
    const emaId = $('#emaId');
    const btnLogin = $('#btnLogin');
    const btnScan = $('#btnScan');
    const btnOpenRegister = $('#btnOpenRegister');
    const btnForgot = $('#btnForgot');
    const saveLogin = $('#saveLogin');

    const registerView = $('#registerView');
    const loginView = $('#loginView');
    const btnRegister = $('#btnRegister');
    const btnBackToLogin = $('#btnBackToLogin');

    const province = $('#province');
    const district = $('#district');
    const forgotProvince = $('#forgotProvince');
    const forgotDistrict = $('#forgotDistrict');

    fillProvinces(province);
    fillProvinces(forgotProvince);

    province.addEventListener('change', () => fillDistricts(district, province.value));
    forgotProvince.addEventListener('change', () => fillDistricts(forgotDistrict, forgotProvince.value));

    // Avatar uploader
    const avatarDrop = $('#avatarDrop');
    const avatarInput = $('#avatarInput');
    const avatarPreview = $('#avatarPreview');
    avatarDrop.addEventListener('click', ()=> avatarInput.click());
    avatarInput.addEventListener('change', (e)=>{
      const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ avatarPreview.src=r.result; avatarPreview.classList.remove('hidden'); avatarDrop.querySelector('.plus').classList.add('hidden'); }; r.readAsDataURL(f);
    });

    // Toggle Register view
    btnOpenRegister.addEventListener('click', ()=>{ loginView.style.display='none'; registerView.classList.add('show'); });
    btnBackToLogin.addEventListener('click', ()=>{ registerView.classList.remove('show'); loginView.style.display='block'; });

    // Validators
    const nameOk = (v)=> v && v.trim().length>=5;
    const phoneOk = (v)=> /^(?:\+94\d{2}\s?\d{3}\s?\d{4}|0\d{2}\s?\d{3}\s?\d{4})$/.test(v.trim());
    const emailOk = (v)=> /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim());

    // Generate EMA ID: 6 digits + '-E'
    const genId = ()=> String(Math.floor(100000 + Math.random()*900000)) + '-E';

    // Save to cookies/localStorage
    function persistId(id){
      try { localStorage.setItem('emaId', id); } catch(_){}
      try { document.cookie = `emaId=${encodeURIComponent(id)}; path=/; max-age=${60*60*24*365}`; } catch(_){}
    }

    // --- Register flow ---
    const registerModal = $('#registerModal');
    const registering = $('#registering');
    const idCardSection = $('#idCardSection');
    const yourIdText = $('#yourIdText');
    const idCardCanvas = $('#idCardCanvas');
    const btnDownloadCard = $('#btnDownloadCard');
    const btnDone = $('#btnDone');
    $('#regClose').addEventListener('click', ()=> closeModal('#registerModal'));

    async function writeUser(id, payload){
      const path = `users/${id}`; // store by ID key
      await set(ref(db, path), payload);
    }

    btnRegister.addEventListener('click', async ()=>{
      const data = {
        name: $('#fullName').value.trim(),
        phone: $('#phone').value.trim(),
        email: $('#email').value.trim(),
        province: province.value,
        district: district.value,
        avatar: avatarPreview.src || '' // base64 for demo
      };
      if(!nameOk(data.name)) return toast('Enter a valid full name (â‰¥ 5 characters)');
      if(!phoneOk(data.phone)) return toast('Enter a valid Sri Lankan phone number');
      if(!emailOk(data.email)) return toast('Enter a valid email');
      if(!data.province) return toast('Select a province');
      if(!data.district) return toast('Select a district');

      const id = genId();

      openModal('#registerModal');
      registering.classList.remove('hidden');
      idCardSection.classList.add('hidden');

      try {
        await writeUser(id, { ...data, createdAt: Date.now(), id });
        // Build ID card
        await buildIdCard({ id, ...data });
        yourIdText.textContent = `${id} is your ID for logging into EMA`;
        registering.classList.add('hidden');
        idCardSection.classList.remove('hidden');
      } catch (e) {
        console.error(e); toast('Could not register. Please try again.'); closeModal('#registerModal');
      }
    });

    btnDownloadCard.addEventListener('click', ()=>{
      const a=document.createElement('a'); a.download='EMA-ID.png'; a.href=idCardCanvas.toDataURL('image/png'); a.click();
    });

    btnDone.addEventListener('click', ()=>{ closeModal('#registerModal'); registerView.classList.remove('show'); loginView.style.display='block'; if(yourIdText.textContent){ const id = yourIdText.textContent.split(' ')[0]; emaId.value = id; toast('ID filled from registration'); } });

    // Draw ID card with QR + Data Matrix
    async function buildIdCard({ id, name, phone, email, province, district, avatar }){
      const ctx = idCardCanvas.getContext('2d');
      // Background
      ctx.clearRect(0,0,idCardCanvas.width,idCardCanvas.height);
      const W=idCardCanvas.width,H=idCardCanvas.height;
      const grad = ctx.createLinearGradient(0,0,W,0); grad.addColorStop(0,'#e0f2fe'); grad.addColorStop(.6,'#f8fafc'); grad.addColorStop(1,'#ffffff');
      ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);
      // Card frame
      ctx.fillStyle='#0ea5e9'; ctx.fillRect(0,0,8,H);
      // Title
      ctx.fillStyle='#0f172a'; ctx.font='bold 28px system-ui, -apple-system, Segoe UI'; ctx.fillText('EMA â€” Elephant Monitoring App', 24, 40);
      // Avatar circle
      const AVX=60, AVY=100, AVR=64;
      if(avatar){ await drawCircleImage(ctx, avatar, AVX+AVR, AVY+AVR, AVR); }
      // Text
      ctx.font='700 26px system-ui'; ctx.fillText(name, 160, 120);
      ctx.font='16px system-ui'; ctx.fillStyle='#334155';
      ctx.fillText(`ID: ${id}`, 160, 150);
      ctx.fillText(`Phone: ${phone}`, 160, 176);
      ctx.fillText(`Email: ${email}`, 160, 202);
      ctx.fillText(`Province: ${province}`, 160, 228);
      ctx.fillText(`District: ${district}`, 160, 254);

      // QR Code (right)
      const qrWrap = document.createElement('div');
      const qr = new QRCode(qrWrap, { text: id, width: 180, height: 180, margin: 1 });
      await new Promise(r=> setTimeout(r, 0)); // allow render
      const qrImg = qrWrap.querySelector('img') || qrWrap.querySelector('canvas');
      await drawImageOnCanvas(ctx, qrImg, W-220, 80, 180, 180);

      // Data Matrix (bottom center)
      const dmCanvas = document.createElement('canvas');
      try { bwipjs.toCanvas(dmCanvas, { bcid:'datamatrix', text:id, scale:3, padding:2 }); } catch(e){ console.warn('DataMatrix gen error', e); }
      await drawImageOnCanvas(ctx, dmCanvas, (W-300)/2, H-130, 300, 90);

      // Footer
      ctx.fillStyle='#0ea5e9'; ctx.fillRect(0,H-8,W,8);
    }

    function drawImageOnCanvas(ctx, el, x,y,w,h){
      return new Promise((res)=>{ const img = new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ ctx.drawImage(img, x,y,w,h); res(); }; img.src = el.toDataURL ? el.toDataURL('image/png') : el.src; });
    }

    function drawCircleImage(ctx, src, cx, cy, r){
      return new Promise((res)=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ ctx.save(); ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.closePath(); ctx.clip(); ctx.drawImage(img, cx-r, cy-r, r*2, r*2); ctx.restore(); res(); }; img.src=src; });
    }

    // --- Scanner ---
    const scanModal = $('#scanModal');
    const scanVideo = $('#scanVideo');
    const scanCanvas = $('#scanCanvas');
    const scanStatus = $('#scanStatus');
    let scanStream = null; let scanning=false;

    async function startScan(){
      openModal('#scanModal');
      try {
        scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        scanVideo.srcObject = scanStream; scanning=true; loopScan();
      } catch (e) { scanStatus.textContent='Camera access denied. Please allow camera.'; }
    }

    async function stopScan(){
      scanning=false; if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
    }

    async function loopScan(){
      const hasBarcodeDetector = 'BarcodeDetector' in window;
      const detector = hasBarcodeDetector ? new BarcodeDetector({ formats: ['qr_code','data_matrix'] }) : null;
      const ctx = scanCanvas.getContext('2d');
      while(scanning){
        if(scanVideo.readyState >= 2){
          scanCanvas.width = scanVideo.videoWidth; scanCanvas.height = scanVideo.videoHeight;
          ctx.drawImage(scanVideo, 0,0, scanCanvas.width, scanCanvas.height);
          try {
            let idText = '';
            if(detector){
              const codes = await detector.detect(scanCanvas);
              if(codes && codes.length){ idText = (codes[0].rawValue||'').trim(); }
            }
            if(!idText){
              // Fallback: jsQR for QR only
              const imgData = ctx.getImageData(0,0, scanCanvas.width, scanCanvas.height);
              const qr = jsQR(imgData.data, imgData.width, imgData.height);
              if(qr && qr.data) idText = qr.data.trim();
            }
            if(idText && /\d{6}-E$/.test(idText)){
              emaId.value = idText; toast('ID captured from card');
              closeModal('#scanModal'); await stopScan(); return;
            } else if(idText) {
              scanStatus.textContent = 'Code read but not a valid EMA ID. Try again.';
            } else {
              scanStatus.textContent = 'Scanningâ€¦ (try aligning the card)';
            }
          } catch (e) { console.warn(e); }
        }
        await new Promise(r=> setTimeout(r, 200));
      }
    }

    $('#scanClose').addEventListener('click', async ()=>{ closeModal('#scanModal'); await stopScan(); });
    btnScan.addEventListener('click', startScan);

    // Forgot ID
    const forgotModal = $('#forgotModal');
    $('#forgotClose').addEventListener('click', ()=> closeModal('#forgotModal'));

    btnForgot.addEventListener('click', ()=> openModal('#forgotModal'));

    $('#btnFindId').addEventListener('click', async ()=>{
      const phone = $('#forgotPhone').value.trim();
      const prov = $('#forgotProvince').value;
      const dist = $('#forgotDistrict').value;
      if(!phoneOk(phone)) return toast('Enter a valid phone number');
      if(!prov || !dist) return toast('Select province & district');
      try {
        const snap = await get(child(ref(db), 'users'));
        if(!snap.exists()) return $('#forgotResult').textContent='No users found.';
        const users = snap.val();
        const found = Object.values(users).find(u=> u.phone===phone && u.province===prov && u.district===dist);
        if(found && found.id){ $('#forgotResult').textContent = `Your EMA ID is: ${found.id}`; } else { $('#forgotResult').textContent='ID not found. Please check the details.'; }
      } catch (e) { console.error(e); toast('Lookup failed. Try again later.'); }
    });

    // Login
    btnLogin.addEventListener('click', ()=>{
      const id = emaId.value.trim();
      if(!/^[0-9]{6}-E$/.test(id)) return toast('Enter a valid EMA ID (e.g., 123456-E)');
      if(saveLogin.checked){ persistId(id); }
      window.location.href = `home.html?id=${encodeURIComponent(id)}`;
    });

    // Restore saved ID
    try { const saved = localStorage.getItem('emaId'); if(saved) { emaId.value = saved; saveLogin.checked = true; } } catch(_){}
  </script>
</body>
</html>
