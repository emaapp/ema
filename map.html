<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EMA • Map</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js")
        .then(() => console.log("Service Worker Registered"))
        .catch(err => console.error("SW reg failed", err));
    }
  </script>

  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica Neue,Arial,Noto Sans,sans-serif}
    .card{background:#fff;border-radius:1rem;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.75rem;padding:.5rem .9rem;font-weight:600}
    #map{position:fixed;inset:56px 0 0 0}
    #loader{position:fixed;inset:0;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;z-index:500}
    .dot{width:.6rem;height:.6rem;border-radius:9999px;background:#000;animation:blink 1s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
    .popup-cta{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);z-index:400}
    .settings-modal,.notif-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:600}
    .settings-modal.show,.notif-modal.show{display:flex}
    .leaflet-control-layers{max-height:240px;overflow:auto}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="w-full fixed top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-100">
    <div class="max-w-screen-xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <img src="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png" class="w-8 h-8" alt="EMA">
        <span class="font-bold">EMA Map</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="settingsBtn" class="icon-btn bg-gray-200 hover:bg-gray-300">Settings</button>
        <a href="home.html" class="icon-btn bg-gray-900 text-white hover:bg-black">Home</a>
      </div>
    </div>
  </header>

  <div id="loader" class="flex-col gap-3">
    <div class="flex gap-2 justify-center"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <div class="text-sm text-gray-700 text-center">Loading latest reports…</div>
  </div>

  <div id="map"></div>

  <div class="notif-modal" id="notifModal">
    <div class="card p-5 w-[95%] max-w-sm text-center">
      <h3 class="text-lg font-semibold mb-3">Notifications</h3>
      <p class="text-sm mb-3">Receive notifications of new reports in your district.</p>
      <select id="districtSelect" class="w-full p-2 border rounded-lg mb-3">
        <option value="">-- Select District --</option>
        <option>Colombo</option>
        <option>Kandy</option>
        <option>Galle</option>
        <option>Kurunegala</option>
        <option>Jaffna</option>
        <option>Matara</option>
        <option>Gampaha</option>
        <option>Monaragala</option>
        <option>Badulla</option>
        <option>Hambantota</option>
        <option>Rathnapura</option>
        <option>Trincomalee</option>
        <option>Anuradhapura</option>
        <option>Polonnaruwa</option>
        <option>Vavuniya</option>
        <option>Mannar</option>
        <option>Killinochchi</option>
        <option>Mullaitivu</option>
        <option>Matale</option>
        <option>Nuwara Eliya</option>
        <option>Kalutara</option>
        <option>Kegalle</option>
        <option>Puttalam</option>
        <option>Ampara</option>
        <option>Batticaloa</option>
      </select>
      <div class="flex gap-2 justify-center">
        <button id="notifAllow" class="icon-btn bg-gray-900 text-white hover:bg-black">Allow</button>
        <button id="notifDeny" class="icon-btn bg-gray-200 hover:bg-gray-300">No Thanks</button>
      </div>
    </div>
  </div>

  <div class="popup-cta hidden" id="zoneBanner">
    <div class="card px-4 py-3 flex items-center gap-3 border border-yellow-300">
      <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
      <div class="text-sm">You’re in a predicted elephant sighting zone. Proceed with caution.</div>
      <button id="closeZoneBanner" class="ml-2 text-xs px-3 py-1 rounded-lg bg-gray-900 text-white">Close</button>
    </div>
  </div>

  <div class="settings-modal" id="settingsModal">
    <div class="card p-5 w-[95%] max-w-sm">
      <h3 class="text-lg font-semibold mb-3">Settings</h3>
      <label class="block text-sm mb-1">Alert Distance (meters)</label>
      <input id="distanceInput" type="number" min="50" step="50" class="w-full p-2 border rounded-lg mb-4"/>
      <div class="flex justify-end gap-2">
        <button id="settingsClose" class="icon-btn bg-gray-200 hover:bg-gray-300">Close</button>
        <button id="settingsSave" class="icon-btn bg-gray-900 text-white hover:bg-black">Save</button>
      </div>
    </div>
  </div>

  <audio id="alertSound" loop>
    <source src="https://audio.jukehost.co.uk/GGFavIeARQ1vKbeJIOGxUNnb27PmZt55" type="audio/mpeg">
  </audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyXXXX",
      authDomain: "ema-app.firebaseapp.com",
      databaseURL: "https://ema-app-default-rtdb.firebaseio.com",
      projectId: "ema-app",
      storageBucket: "ema-app.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const loader=document.getElementById("loader");
    const notifModal=document.getElementById("notifModal");
    const notifAllow=document.getElementById("notifAllow");
    const notifDeny=document.getElementById("notifDeny");
    const districtSelect=document.getElementById("districtSelect");
    const settingsBtn=document.getElementById("settingsBtn");
    const settingsModal=document.getElementById("settingsModal");
    const settingsClose=document.getElementById("settingsClose");
    const settingsSave=document.getElementById("settingsSave");
    const distanceInput=document.getElementById("distanceInput");
    const zoneBanner=document.getElementById("zoneBanner");
    const closeZoneBanner=document.getElementById("closeZoneBanner");
    const alertSound=document.getElementById("alertSound");

    let alertDistance=Number(getCookie("alertDistance")||200);
    distanceInput.value=alertDistance;

    if(!getCookie("notifDistrict")) notifModal.classList.add("show");

    notifAllow.onclick=()=>{
      if(districtSelect.value!==""){
        setCookie("notifDistrict",districtSelect.value,365);
        notifModal.classList.remove("show");
        alert("Notifications enabled for "+districtSelect.value);
      }
    };
    notifDeny.onclick=()=>{notifModal.classList.remove("show")};

    settingsBtn.onclick=()=>settingsModal.classList.add("show");
    settingsClose.onclick=()=>settingsModal.classList.remove("show");
    settingsSave.onclick=()=>{
      alertDistance=Number(distanceInput.value);
      setCookie("alertDistance",alertDistance,365);
      settingsModal.classList.remove("show");
    };

    closeZoneBanner.onclick=()=>zoneBanner.classList.add("hidden");

    const map=L.map("map").setView([7.8731,80.7718],7);
    const osm=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
    const esri=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");
    osm.addTo(map);
    L.control.layers({"OSM":osm,"ESRI Satellite":esri}).addTo(map);

    navigator.geolocation.getCurrentPosition(pos=>{
      map.setView([pos.coords.latitude,pos.coords.longitude],10);
    });

    function msAgo(t){return (Date.now()-t)/3600000}
    function km2deg(km){return km/111}
    function setCookie(n,v,d){let e="";if(d){const date=new Date();date.setTime(date.getTime()+(d*24*60*60*1000));e="; expires="+date.toUTCString()}document.cookie=n+"="+(v||"")+e+"; path=/"}
    function getCookie(n){let nameEQ=n+"=",ca=document.cookie.split(";");for(let i=0;i<ca.length;i++){let c=ca[i];while(c.charAt(0)==" ")c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return c.substring(nameEQ.length,c.length)}return null}

    db.ref("reports").on("value",snap=>{
      loader.style.display="none";
      map.eachLayer(l=>{if(l.options&&l.options.pane==="markerPane")map.removeLayer(l)});
      snap.forEach(child=>{
        let r=child.val();
        if(r.hidden) return;
        if(msAgo(r.timestamp)>15) return;
        let color=r.type==="accident"?"blue":r.level==="high"?"red":r.level==="medium"?"yellow":"green";
        let marker=L.circleMarker([r.lat,r.lng],{radius:8,color}).addTo(map);
        marker.bindPopup(`<b>${r.type||"Sighting"}</b><br>${new Date(r.timestamp).toLocaleString()}<br>${r.details||""}`);
        let hours=msAgo(r.timestamp);
        let radius=(hours+1)*0.5;
        L.circle([r.lat,r.lng],{radius:radius*1000,color:color,fillOpacity:0.1}).addTo(map);
        navigator.geolocation.watchPosition(pos=>{
          let d=L.latLng(pos.coords.latitude,pos.coords.longitude).distanceTo([r.lat,r.lng]);
          if(d<5000){zoneBanner.classList.remove("hidden")}
          if(d<alertDistance){alertSound.play();let n=0;let inter=setInterval(()=>{if(n>=5)return clearInterval(inter);if(Notification.permission==="granted"){new Notification("EMA Alert",{body:`You’re ${Math.round(d)}m from an elephant sighting. Proceed with caution.`})}n++},20000)}
        });
      });
    });

    if(Notification.permission!=="granted") Notification.requestPermission();
  </script>
</body>
</html>
