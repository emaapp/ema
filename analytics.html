<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EMA â€¢ Analytics</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
  <header class="w-full sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-100">
    <div class="max-w-screen-md mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <img src="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png" class="w-8 h-8" alt="EMA">
        <span class="font-bold">EMA Analytics</span>
      </div>
      <a href="home.html" class="px-4 py-2 rounded-lg bg-gray-900 text-white hover:bg-black">Home</a>
    </div>
  </header>

  <main class="max-w-screen-md mx-auto px-4 py-6 space-y-6">
    <section class="bg-white shadow rounded-2xl p-6 space-y-4">
      <h2 class="text-xl font-semibold">Overview</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
        <div class="p-4 bg-gray-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="totalReports">0</p>
          <p class="text-sm">Total Reports</p>
        </div>
        <div class="p-4 bg-blue-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="sightings">0</p>
          <p class="text-sm">Sightings</p>
        </div>
        <div class="p-4 bg-red-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="accidents">0</p>
          <p class="text-sm">Accidents</p>
        </div>
        <div class="p-4 bg-green-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="users">0</p>
          <p class="text-sm">Users</p>
        </div>
        <div class="p-4 bg-yellow-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="dangerHigh">0</p>
          <p class="text-sm">High Danger</p>
        </div>
        <div class="p-4 bg-orange-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="dangerMed">0</p>
          <p class="text-sm">Medium Danger</p>
        </div>
      </div>
      <button id="downloadReports" class="mt-4 w-full bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-black">Download Reports</button>
    </section>

    <section class="bg-white shadow rounded-2xl p-6 space-y-4">
      <h2 class="text-xl font-semibold">Admin Panel</h2>
      <button id="adminBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Enter Admin Panel</button>
      <div id="adminPanel" class="hidden mt-6 overflow-x-auto">
        <h3 class="text-lg font-bold mb-2">Full Database</h3>
        <pre id="dbData" class="p-3 bg-gray-100 rounded-lg text-xs overflow-auto max-h-96"></pre>
        <button id="downloadDB" class="mt-4 w-full bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-black">Download Database</button>
      </div>
    </section>
  </main>

  <div id="popup" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full text-center">
      <p id="popupMsg">Message</p>
      <button onclick="document.getElementById('popup').classList.add('hidden')" class="mt-4 bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-black w-full">Close</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIqO8zSyUiYYHe-vBMozYYrQs6Br8rt68",
      authDomain: "project-ema-998cd.firebaseapp.com",
      databaseURL: "https://project-ema-998cd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "project-ema-998cd",
      storageBucket: "project-ema-998cd.firebasestorage.app",
      messagingSenderId: "356739398551",
      appId: "1:356739398551:web:df3f900d8d7a07c38e22d2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const totalReports = document.getElementById("totalReports");
    const sightings = document.getElementById("sightings");
    const accidents = document.getElementById("accidents");
    const users = document.getElementById("users");
    const dangerHigh = document.getElementById("dangerHigh");
    const dangerMed = document.getElementById("dangerMed");

    async function loadAnalytics() {
      const snapSightings = await get(child(ref(db), "reports/sightings"));
      const snapAccidents = await get(child(ref(db), "reports/accidents"));
      const snapUsers = await get(child(ref(db), "users"));

      let sightCount = snapSightings.exists() ? Object.keys(snapSightings.val()).length : 0;
      let accCount = snapAccidents.exists() ? Object.keys(snapAccidents.val()).length : 0;
      let userCount = snapUsers.exists() ? Object.keys(snapUsers.val()).length : 0;

      sightings.textContent = sightCount;
      accidents.textContent = accCount;
      users.textContent = userCount;
      totalReports.textContent = sightCount + accCount;

      let high = 0, med = 0;
      if (snapSightings.exists()) {
        Object.values(snapSightings.val()).forEach(r => {
          if (r.danger === "High") high++;
          if (r.danger === "Medium") med++;
        });
      }
      dangerHigh.textContent = high;
      dangerMed.textContent = med;
    }

    loadAnalytics();

    function downloadJSON(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    document.getElementById("downloadReports").onclick = async () => {
      const snapSightings = await get(child(ref(db), "reports/sightings"));
      const snapAccidents = await get(child(ref(db), "reports/accidents"));
      let allReports = {
        sightings: snapSightings.exists() ? snapSightings.val() : {},
        accidents: snapAccidents.exists() ? snapAccidents.val() : {}
      };
      downloadJSON("reports.json", allReports);
    };

    document.getElementById("adminBtn").onclick = async () => {
      let pwd = prompt("Enter admin password:");
      if (pwd === "aveesha@homewhen10") {
        const snap = await get(ref(db));
        document.getElementById("dbData").textContent = JSON.stringify(snap.val(), null, 2);
        document.getElementById("adminPanel").classList.remove("hidden");
      } else {
        document.getElementById("popupMsg").textContent = "Wrong password!";
        document.getElementById("popup").classList.remove("hidden");
      }
    };

    document.getElementById("downloadDB").onclick = async () => {
      const snap = await get(ref(db));
      downloadJSON("ema_database.json", snap.val() || {});
    };
  </script>
</body>
</html>
