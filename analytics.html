<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EMA • Analytics</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
  <header class="w-full sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-screen-md mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="font-bold text-lg flex items-center gap-2">
        <img src="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png" class="w-8 h-8">
        EMA Analytics
      </h1>
      <a href="home.html" class="px-4 py-2 rounded-lg bg-gray-900 text-white hover:bg-black">Home</a>
    </div>
  </header>

  <main class="max-w-screen-md mx-auto px-4 py-6 space-y-6">
    <section class="bg-white shadow rounded-2xl p-6 space-y-4">
      <h2 class="text-xl font-semibold">Overview</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
        <div class="p-4 bg-gray-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="totalReports">–</p>
          <p class="text-sm">Total Reports</p>
        </div>
        <div class="p-4 bg-blue-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="sightings">–</p>
          <p class="text-sm">Sightings</p>
        </div>
        <div class="p-4 bg-red-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="accidents">–</p>
          <p class="text-sm">Accidents</p>
        </div>
        <div class="p-4 bg-green-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="users">–</p>
          <p class="text-sm">Users</p>
        </div>
        <div class="p-4 bg-yellow-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="dangerHigh">–</p>
          <p class="text-sm">High Danger</p>
        </div>
        <div class="p-4 bg-orange-100 rounded-xl text-center">
          <p class="text-2xl font-bold" id="dangerMed">–</p>
          <p class="text-sm">Medium Danger</p>
        </div>
      </div>
      <button id="downloadReports" class="mt-4 w-full bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-black">Download Reports</button>
    </section>

    <section class="bg-white shadow rounded-2xl p-6 space-y-4">
      <h2 class="text-xl font-semibold">Admin Panel</h2>
      <button id="adminBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Open Admin Panel</button>
    </section>
  </main>

  <div id="popup" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-lg w-full space-y-4">
      <h3 id="popupTitle" class="text-lg font-semibold">Popup</h3>
      <div id="popupContent" class="text-sm max-h-96 overflow-auto"></div>
      <div class="flex gap-2 justify-end">
        <button id="popupClose" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-black">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIqO8zSyUiYYHe-vBMozYYrQs6Br8rt68",
      authDomain: "project-ema-998cd.firebaseapp.com",
      databaseURL: "https://project-ema-998cd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "project-ema-998cd",
      storageBucket: "project-ema-998cd.firebasestorage.app",
      messagingSenderId: "356739398551",
      appId: "1:356739398551:web:df3f900d8d7a07c38e22d2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const totalReports = document.getElementById("totalReports");
    const sightings = document.getElementById("sightings");
    const accidents = document.getElementById("accidents");
    const users = document.getElementById("users");
    const dangerHigh = document.getElementById("dangerHigh");
    const dangerMed = document.getElementById("dangerMed");

    async function loadAnalytics() {
      try {
        const snapSightings = await get(child(ref(db), "reports/sightings"));
        const snapAccidents = await get(child(ref(db), "reports/accidents"));
        const snapUsers = await get(child(ref(db), "users"));

        const sightData = snapSightings.exists() ? snapSightings.val() : {};
        const accData = snapAccidents.exists() ? snapAccidents.val() : {};
        const userData = snapUsers.exists() ? snapUsers.val() : {};

        const sightCount = Object.keys(sightData).length;
        const accCount = Object.keys(accData).length;
        const userCount = Object.keys(userData).length;

        sightings.textContent = sightCount;
        accidents.textContent = accCount;
        users.textContent = userCount;
        totalReports.textContent = sightCount + accCount;

        let high = 0, med = 0;
        Object.values(sightData).forEach(r => {
          if (r.danger === "High") high++;
          if (r.danger === "Medium") med++;
        });
        dangerHigh.textContent = high;
        dangerMed.textContent = med;
      } catch (e) {
        console.error("Analytics load error", e);
      }
    }
    loadAnalytics();

    function downloadJSON(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    document.getElementById("downloadReports").onclick = async () => {
      const snapSightings = await get(child(ref(db), "reports/sightings"));
      const snapAccidents = await get(child(ref(db), "reports/accidents"));
      let allReports = {
        sightings: snapSightings.exists() ? snapSightings.val() : {},
        accidents: snapAccidents.exists() ? snapAccidents.val() : {}
      };
      downloadJSON("reports.json", allReports);
    };

    const popup = document.getElementById("popup");
    const popupContent = document.getElementById("popupContent");
    const popupTitle = document.getElementById("popupTitle");
    document.getElementById("popupClose").onclick = () => popup.classList.add("hidden");

    document.getElementById("adminBtn").onclick = () => {
      popupTitle.textContent = "Admin Login";
      popupContent.innerHTML = `
        <input id="adminPass" type="password" placeholder="Enter password" class="w-full border rounded-lg p-2 mb-3">
        <button id="adminLogin" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Login</button>
      `;
      popup.classList.remove("hidden");

      document.getElementById("adminLogin").onclick = async () => {
        let pwd = document.getElementById("adminPass").value;
        if (pwd === "aveesha@homewhen10") {
          const snap = await get(ref(db));
          popupTitle.textContent = "Admin Panel";
          popupContent.innerHTML = `
            <pre class="p-3 bg-gray-100 rounded-lg text-xs overflow-auto max-h-80">${JSON.stringify(snap.val(), null, 2)}</pre>
            <button id="downloadDB" class="mt-3 w-full bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-black">Download Database</button>
          `;
          document.getElementById("downloadDB").onclick = () => {
            downloadJSON("ema_database.json", snap.val() || {});
          };
        } else {
          popupTitle.textContent = "Error";
          popupContent.innerHTML = `<p class="text-red-600">Wrong password!</p>`;
        }
      };
    };
  </script>
</body>
</html>
