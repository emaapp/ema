<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EMA - Home</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/emaapp/ema/refs/heads/main/logo/logo_main.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; }
    .popup-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; position: relative; }
    .close-btn { position: absolute; top: 1rem; right: 1rem; cursor: pointer; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen p-4">
  <div class="max-w-md mx-auto space-y-6">
    <!-- User Info Card -->
    <div id="user-card" class="bg-white p-4 rounded-2xl shadow flex items-center cursor-pointer">
      <img id="user-pic" src="" class="w-16 h-16 rounded-full border-2 border-blue-500 object-cover mr-4" alt="User">
      <div>
        <h2 id="greeting" class="text-lg font-bold">Hello</h2>
        <p class="text-sm text-gray-500">Touch on the card to edit</p>
      </div>
    </div>
    <button id="signout-btn" class="w-full bg-red-600 text-white py-2 rounded-lg shadow">Sign Out</button>

    <!-- Weather Card -->
    <div class="bg-white p-4 rounded-2xl shadow">
      <h3 id="weather-location" class="text-lg font-bold mb-2">Weather</h3>
      <p id="weather-temp" class="text-xl font-semibold"></p>
      <p id="weather-condition" class="text-sm text-gray-600"></p>
      <p id="weather-humidity" class="text-sm text-gray-600"></p>
      <p id="weather-wind" class="text-sm text-gray-600 mb-4"></p>
      <div class="flex justify-between items-center">
        <p class="text-sm text-gray-500">Found a sighting? Report</p>
        <button class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center">+</button>
      </div>
    </div>

    <!-- Agent Status Card -->
    <div id="agent-card" class="bg-white p-4 rounded-2xl shadow">
      <h3 class="text-lg font-bold mb-2">Agent Status</h3>
      <p id="agent-status" class="mb-4">Not an Agent</p>
      <button id="agent-action-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg">Register</button>
    </div>

    <!-- Actions Card -->
    <div class="bg-white p-4 rounded-2xl shadow grid grid-cols-2 gap-4 text-center">
      <a href="report.html" class="bg-blue-600 text-white py-2 rounded-lg shadow">Report</a>
      <a href="alert.html" class="bg-red-600 text-white py-2 rounded-lg shadow">Alert</a>
      <a href="map.html" class="bg-green-600 text-white py-2 rounded-lg shadow">Map</a>
      <a href="service.html" class="bg-yellow-500 text-white py-2 rounded-lg shadow">Service</a>
      <a href="analytics.html" class="col-span-2 bg-purple-600 text-white py-2 rounded-lg shadow">Analytics</a>
    </div>
  </div>

  <!-- Edit User Popup -->
  <div id="edit-popup" class="popup-overlay hidden">
    <div class="popup-content">
      <button class="close-btn" onclick="hidePopup('edit-popup')">✖</button>
      <h3 class="text-xl font-bold mb-4">Edit Profile</h3>
      <input id="edit-name" type="text" placeholder="Full Name" class="w-full mb-2 px-3 py-2 border rounded-lg">
      <input id="edit-phone" type="text" placeholder="Phone" class="w-full mb-2 px-3 py-2 border rounded-lg">
      <input id="edit-email" type="email" placeholder="Email" class="w-full mb-2 px-3 py-2 border rounded-lg">
      <button id="save-user-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg">Save</button>
    </div>
  </div>

  <!-- Agent Popup -->
  <div id="agent-popup" class="popup-overlay hidden">
    <div class="popup-content">
      <button class="close-btn" onclick="hidePopup('agent-popup')">✖</button>
      <h3 class="text-xl font-bold mb-4">Register as Agent</h3>
      <input id="agent-name" type="text" placeholder="Full Name" class="w-full mb-2 px-3 py-2 border rounded-lg">
      <input id="agent-phone" type="text" placeholder="Mobile Number" class="w-full mb-2 px-3 py-2 border rounded-lg">
      <input id="agent-nic" type="text" placeholder="NIC Number" class="w-full mb-2 px-3 py-2 border rounded-lg">
      <button id="register-agent-btn" class="w-full bg-green-600 text-white py-2 rounded-lg">Register</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, get, set, update, child } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIqO8zSyUiYYHe-vBMozYYrQs6Br8rt68",
      authDomain: "project-ema-998cd.firebaseapp.com",
      databaseURL: "https://project-ema-998cd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "project-ema-998cd",
      storageBucket: "project-ema-998cd.firebasestorage.app",
      messagingSenderId: "356739398551",
      appId: "1:356739398551:web:df3f900d8d7a07c38e22d2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id') || localStorage.getItem('emaUserId');
    if (!userId) window.location.href = 'index.html';

    const userCard = document.getElementById('user-card');
    const userPic = document.getElementById('user-pic');
    const greeting = document.getElementById('greeting');
    const agentStatus = document.getElementById('agent-status');
    const agentBtn = document.getElementById('agent-action-btn');

    function showPopup(id) { document.getElementById(id).classList.remove('hidden'); }
    function hidePopup(id) { document.getElementById(id).classList.add('hidden'); }

    function getGreeting() {
      const hour = new Date().getHours();
      if (hour < 12) return "Morning";
      if (hour < 18) return "Afternoon";
      return "Evening";
    }

    function generateWeather(district) {
      const conditions = ["Sunny", "Cloudy", "Rainy", "Windy", "Stormy"];
      const condition = conditions[Math.floor(Math.random() * conditions.length)];
      const temp = (25 + Math.random() * 10).toFixed(1);
      const humidity = (60 + Math.random() * 20).toFixed(0);
      const wind = (5 + Math.random() * 10).toFixed(1);
      document.getElementById('weather-location').innerText = `Weather in ${district}`;
      document.getElementById('weather-temp').innerText = `${temp}°C`;
      document.getElementById('weather-condition').innerText = condition;
      document.getElementById('weather-humidity').innerText = `Humidity: ${humidity}%`;
      document.getElementById('weather-wind').innerText = `Wind: ${wind} km/h`;
    }

    async function loadUser() {
      const snapshot = await get(child(ref(db), `users/${userId}`));
      if (snapshot.exists()) {
        const data = snapshot.val();
        userPic.src = data.profilePic || "";
        const firstName = data.name.split(" ")[0];
        greeting.innerText = `Hello ${firstName}, Good ${getGreeting()}`;
        generateWeather(data.district);

        if (data.agent) {
          agentStatus.innerText = `Agent (ID: ${data.agent.id})`;
          agentBtn.innerText = "Unregister";
          agentBtn.classList.remove('bg-green-600');
          agentBtn.classList.add('bg-red-600');
        }
      } else {
        window.location.href = 'index.html';
      }
    }

    document.getElementById('signout-btn').addEventListener('click', () => {
      localStorage.clear();
      document.cookie = "emaUserId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      window.location.href = 'index.html';
    });

    userCard.addEventListener('click', () => {
      showPopup('edit-popup');
    });

    document.getElementById('save-user-btn').addEventListener('click', async () => {
      const name = document.getElementById('edit-name').value;
      const phone = document.getElementById('edit-phone').value;
      const email = document.getElementById('edit-email').value;
      await update(ref(db, `users/${userId}`), { name, phone, email });
      hidePopup('edit-popup');
      loadUser();
    });

    agentBtn.addEventListener('click', () => {
      if (agentBtn.innerText === "Register") {
        showPopup('agent-popup');
      } else {
        update(ref(db, `users/${userId}/agent`), null);
        localStorage.removeItem('agentId');
        agentStatus.innerText = "Not an Agent";
        agentBtn.innerText = "Register";
        agentBtn.classList.remove('bg-red-600');
        agentBtn.classList.add('bg-green-600');
      }
    });

    document.getElementById('register-agent-btn').addEventListener('click', async () => {
      const name = document.getElementById('agent-name').value;
      const phone = document.getElementById('agent-phone').value;
      const nic = document.getElementById('agent-nic').value;
      const id = `${Math.floor(1000 + Math.random() * 9000)}-A`;
      await set(ref(db, `users/${userId}/agent`), { id, name, phone, nic });
      localStorage.setItem('agentId', id);
      hidePopup('agent-popup');
      loadUser();
    });

    loadUser();
  </script>
</body>
</html>
